name: Zephyr CI/CD

on:
  push:
    branches: [master, main, develop]
    tags:
      - "v*"
  pull_request:
    branches: [master, main, develop]
  workflow_dispatch:

jobs:
  build:
    name: Build Firmware
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/zephyrproject-rtos/ci:v0.27.2
      options: --user root
    env:
      PIO_CACHE_DIR: /tmp/pio-cache

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache PlatformIO
        if: github.actor != 'nektos/act'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.platformio/.cache
          key: ${{ runner.os }}-pio-zephyr-${{ hashFiles('**/platformio.ini') }}
          restore-keys: |
            ${{ runner.os }}-pio-zephyr-

      - name: Setup PlatformIO
        run: |
          apt-get update -qq
          apt-get install -y -qq python3-venv python3-pip
          python3 -m pip install -q --upgrade pip platformio

      - name: Build firmware
        run: |
          echo "=== Starting build ==="
          echo "Working directory: $(pwd)"
          echo "Running as: $(whoami) (UID: $(id -u))"

          # Run the build
          pio run

          echo "=== Build completed ==="

          # Fix permissions for .pio directory (important for act local testing)
          # This ensures the directory is accessible on the host filesystem
          if [ -d .pio ]; then
            echo "Fixing .pio directory permissions..."
            chmod -R 755 .pio 2>/dev/null || true

            # Try to match ownership to workspace (works with act --bind)
            WORKSPACE_UID=$(stat -c '%u' . 2>/dev/null || echo "1000")
            WORKSPACE_GID=$(stat -c '%g' . 2>/dev/null || echo "1000")
            chown -R ${WORKSPACE_UID}:${WORKSPACE_GID} .pio 2>/dev/null || true

            echo "✅ .pio directory permissions fixed"
            ls -ld .pio
          fi

      - name: Show build results
        run: |
          echo "=== Build artifacts ==="
          ls -lh .pio/build/seeed-xiao-nrf54l15/
          if [ -f .pio/build/seeed-xiao-nrf54l15/firmware.elf ]; then
            echo "✅ Firmware built successfully"
            arm-zephyr-eabi-size .pio/build/seeed-xiao-nrf54l15/firmware.elf || true
          fi
          if [ -f .pio/build/seeed-xiao-nrf54l15/firmware.hex ]; then
            echo "✅ Firmware HEX file ready for flashing"
            ls -lh .pio/build/seeed-xiao-nrf54l15/firmware.hex
          fi

      - name: Upload firmware.hex artifact
        if: github.actor != 'nektos/act'
        uses: actions/upload-artifact@v4
        with:
          name: firmware-hex
          path: .pio/build/seeed-xiao-nrf54l15/firmware.hex
          retention-days: 30

      - name: Upload all firmware artifacts
        if: github.actor != 'nektos/act'
        uses: actions/upload-artifact@v4
        with:
          name: firmware-all
          path: |
            .pio/build/seeed-xiao-nrf54l15/firmware.hex
            .pio/build/seeed-xiao-nrf54l15/firmware.elf
          retention-days: 30

  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/zephyrproject-rtos/ci:v0.28.8
      options: --user root

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Zephyr workspace
        if: github.actor != 'nektos/act'
        uses: actions/cache@v4
        with:
          path: /zephyr-workspace
          key: zephyr-workspace-v4.2.0  # bump this when changing west init --mr version below
          restore-keys: |
            zephyr-workspace-

      - name: Init Zephyr workspace
        run: |
          if [ -d /zephyr-workspace/zephyr ]; then
            echo "Zephyr workspace already initialised (cache hit)"
          else
            echo "Initialising Zephyr v4.2.0 workspace..."
            mkdir -p /zephyr-workspace
            cd /zephyr-workspace
            west init --mr v4.2.0
            west update --narrow --fetch-opt=--depth=1 zephyr
            echo "Zephyr workspace ready"
          fi

      - name: Run unit tests
        run: |
          set -e
          export ZEPHYR_BASE=/zephyr-workspace/zephyr
          export ZEPHYR_TOOLCHAIN_VARIANT=zephyr
          export ZEPHYR_SDK_INSTALL_DIR=/opt/toolchains/zephyr-sdk-0.17.4

          PASS=0
          FAIL=0
          FAILED_SUITES=""

          for suite in tests/*/; do
            [ -f "${suite}CMakeLists.txt" ] || continue
            name=$(basename "$suite")
            echo ""
            echo "=== Suite: $name ==="
            cd "$GITHUB_WORKSPACE/$suite"
            rm -rf build
            if cmake -B build -GNinja -DBOARD=unit_testing 2>&1 && \
               ninja -C build 2>&1 && \
               ./build/testbinary 2>&1; then
              PASS=$((PASS + 1))
            else
              FAIL=$((FAIL + 1))
              FAILED_SUITES="$FAILED_SUITES $name"
              echo "FAILED: $name"
            fi
            cd "$GITHUB_WORKSPACE"
          done

          echo ""
          echo "=== RESULTS: $PASS passed, $FAIL failed ==="
          if [ -n "$FAILED_SUITES" ]; then
            echo "Failed suites:$FAILED_SUITES"
          fi
          [ "$FAIL" -eq 0 ]

  release:
    name: Create Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build, unit-test]
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all firmware artifacts
        uses: actions/download-artifact@v4
        with:
          name: firmware-all
          path: ./release

      - name: List release files
        run: |
          echo "=== Files to be released ==="
          ls -lh ./release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./release/firmware.hex
            ./release/firmware.elf
          body: |
            ## RadPro-Link Firmware ${{ github.ref_name }}

            **Target Board**: Seeed Studio XIAO nRF54L15
            **Purpose**: BLE interface for RadPro radiation detector devices

            ### Firmware Files
            - **firmware.hex** - Intel HEX format (recommended for most flashers)
            - **firmware.elf** - ELF executable with debug symbols

            ### Installation
            Flash the firmware to your board using:
            - **nRF Connect Programmer** (recommended) - use `firmware.hex`
            - **OpenOCD** - use `firmware.hex`
            - **pyOCD** - use `firmware.hex`
            - **J-Link Commander** - use `firmware.hex`

            ### Changes
            See commit history for details.
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
